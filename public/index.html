<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Simulator</title>
  
    <!-- Socket IO -->
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- fullPannel -->
    <div id="fullPannel" class="col-xl-12">

        <!-- floatLeft -->
        <div id="floatLeft" class="col-xl-2">
            <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width: 100%;">

                <hr>
                <ul class="nav nav-pills flex-column mb-auto">

                  <button id="btnShowCardsLigaMagic" onclick="showModal('#addCardsLigaMagic')" type="button" class="btn btn-primary leftMenuButtons" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    Entrar na Partida
                  </button>

                </ul>
                <div id="playerNameLabel"></div>
                <div style="
                  display: flex;
                  flex-direction: column;
                  align-content: center;
                  justify-content: space-evenly;
                  align-items: stretch;
                  flex-wrap: wrap;">

                  <div style="display: flex;">

                    <div id="exilium" class="pile">
                      <div class="titlePile">Exílio</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>
                    <div id="grave" class="pile">
                      <div class="titlePile">Cemitério</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>
                    <div id="commander" class="pile">
                      <div class="titlePile">Comando</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>

                  </div>
                  <div id="deck" style="display: flex;">
                    <div  class="pile">
                      <div class="titlePile">Grimório</div>
                      <img id="draw" draggable="true" ondragstart="drag(event)" src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="180pt">
                    </div>
                  </div>
                </div>
                
                <hr>
                
                <div class="dropdown">
                  
                  <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="#">New project...</a></li>
                    <li><a class="dropdown-item" href="#">Settings</a></li>
                    <li><a class="dropdown-item" href="#">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">Sign out</a></li>
                  </ul>
                </div>
              </div>
        </div>

        <!-- containerCenter -->
        <div id="containerCenter" class="col-xl-8"">
            <div id="containerTop" class="playerCards " ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            <div id="fullArena" >

              <div id="arenaOpponentLands" class="containerArena containerLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="arenaOpponentCards" class="containerArena containerNonLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="divisor"><div class="boardCard"></div></div>
              <div id="arenaPlayerCards" class="containerArena containerNonLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="arenaPlayerLands" class="containerArena containerLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              
            </div>
            <div id="containerBottom" class="playerCards" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
        </div>

        <!-- floatRight -->
        <div id="floatRight" class="col-xl-2">
            <div id="amplifierCard">
              <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" srcset="">
            </div>

            <div id="pannel" class="mb-3">
              <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 100%;">
                <div id="colors" class="list-group list-group-flush border-bottom scrollarea">
                  <div onclick="setColor('colorblue')" class="colorButton colorblue"></div>
                  <div onclick="setColor('colorblueviolet')" class="colorButton colorblueviolet"></div>
                  <div onclick="setColor('colordeeppink')" class="colorButton colordeeppink"></div>
                  <div onclick="setColor('colorhotpink')" class="colorButton colorhotpink"></div>
                  <div onclick="setColor('colorred')" class="colorButton colorred"></div>
                  <div onclick="setColor('coloryellow')" class="colorButton coloryellow"></div>
                  <div onclick="setColor('colororangered')" class="colorButton colororangered"></div>
                  <div onclick="setColor('colorspringgreen')" class="colorButton colorspringgreen"></div>
                  <div onclick="setColor('colormidnightblue')" class="colorButton colormidnightblue"></div>
                  <div onclick="setColor('colorolivedrab')" class="colorButton colorolivedrab"></div>
                </div>
                <div class="list-group list-group-flush border-bottom scrollarea" style="padding: 2px;flex-flow: row;">
                  <div id="selectedColor" style="padding: 5px; border-radius: 5px;">
                    <div style="padding: 5px;"></div>
                  </div>
                  <div style="padding: 5px;">Cor Selecionada</div>
                </div>
              </div>
            </div>

            <div id="logPannel">
              <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 100%;">
                <a href="/" class="d-flex align-items-center flex-shrink-0 p-3 link-dark text-decoration-none border-bottom">
                  <svg class="bi me-2" width="30" height="24"><use xlink:href="#bootstrap"></use></svg>
                  <span class="fs-5 fw-semibold">Histórico da partida</span>
                </a>
                <div id="logs" class="list-group list-group-flush border-bottom scrollarea">
                </div>
              </div>
            </div>
        </div>

    </div>

    <!-- MODAL Add Cards Liga Magic -->
    <div class="modal fade" id="addCardsLigaMagic" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Iniciar Jogo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal('#addCardsLigaMagic')"></button>
          </div>
          <div class="modal-body">
            <label for="deckUri">Nome</label>
            <input id="playerName" class="form-control" type="text" placeholder="URL do deck">
          </div>
          <div class="modal-body">
            <label for="deckUri">Insira o Endereço do Deck</label>
            <input id="deckUri" class="form-control" type="text" placeholder="URL do deck">
          </div>
          <div id="alertAddCards" class="alert alert-dark m-3" role="alert">
            <div class="spinner-border" role="status" style="margin-right: 10px;">
              <span class="sr-only">Loading...</span>
            </div>
            Carregando os cards
          </div>
          <div class="modal-footer" style="flex-flow: row;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal('#addCardsLigaMagic')">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="init()">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    
    <script type="text/javascript">
        $("#alertAddCards").hide();

        // consts
        const keyCode_space = 32;
        const keyCode_0 = 48;
        const keyCode_1 = 49;
        const keyCode_2 = 50;
        const keyCode_3 = 51;
        const keyCode_4 = 52;
        const keyCode_5 = 53;
        const keyCode_6 = 54;
        const keyCode_7 = 55;
        const keyCode_8 = 56;
        const keyCode_9 = 57;

        var defaultCard = "https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg";
        var SelectedObject = {};
        var selectedColor = "none";
        var player = "";
        var refreshDeck = false;
        var keySpacePressed = false;
        var key0Pressed = false;
        var key1Pressed = false;
        var key2Pressed = false;
        var key3Pressed = false;
        var key4Pressed = false;
        var key5Pressed = false;
        var key6Pressed = false;
        var key7Pressed = false;
        var key8Pressed = false;
        var key9Pressed = false;
        var socket = setServer();
        
        showDeck();
        
        function showDeck(){
          if (refreshDeck){
            $("#exilium").show();
            $("#grave").show();
            $("#commander").show();
            $("#deck").show();
          }else{
            $("#exilium").hide();
            $("#grave").hide();
            $("#commander").hide();
            $("#deck").hide();
          }
        }

        function setServer(){
          var server = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
            ? "localhost"
            : "192.168.0.110";
          return io('http://' + server + ':3000');
        }
        
        $(window).keydown(function(ev) {
          if (ev.which == keyCode_space) {keySpacePressed = true;}
          if (ev.which == keyCode_0) {key0Pressed = true;}
          if (ev.which == keyCode_1) {key1Pressed = true;}
          if (ev.which == keyCode_2) {key2Pressed = true;}
          if (ev.which == keyCode_3) {key3Pressed = true;}
          if (ev.which == keyCode_4) {key4Pressed = true;}
          if (ev.which == keyCode_5) {key5Pressed = true;}
          if (ev.which == keyCode_6) {key6Pressed = true;}
          if (ev.which == keyCode_7) {key7Pressed = true;}
          if (ev.which == keyCode_8) {key8Pressed = true;}
          if (ev.which == keyCode_9) {key9Pressed = true;}
        }).keyup(function(ev) {
          if (ev.which == keyCode_space) {keySpacePressed = false;}
          if (ev.which == keyCode_0) {key0Pressed  = false;}
          if (ev.which == keyCode_1) {key1Pressed  = false;}
          if (ev.which == keyCode_2) {key2Pressed  = false;}
          if (ev.which == keyCode_3) {key3Pressed  = false;}
          if (ev.which == keyCode_4) {key4Pressed  = false;}
          if (ev.which == keyCode_5) {key5Pressed  = false;}
          if (ev.which == keyCode_6) {key6Pressed  = false;}
          if (ev.which == keyCode_7) {key7Pressed  = false;}
          if (ev.which == keyCode_8) {key8Pressed  = false;}
          if (ev.which == keyCode_9) {key9Pressed  = false;}
        });

        socket.on('updateGame', function(game){
          updateGame(game);
        })

        socket.on('showLoading', function(game){
          showLoading(game);
        })

        socket.on('closeModalAddCards', function(game){
          closeModal('#addCardsLigaMagic');
        })

        // function addPlayer(playerName){
        //   player = playerName;
        //   $("#playerName").html('');
        //   $("#playerName").append(player);
        //   socket.emit('addPlayer', player);
        // }

        // function setColor(color){
        //   console.log(color)
        //   document.getElementById('selectedColor').className = color;
        //   selectedColor = color;
        //   console.log(color)
        // }

        // function getColorFront(color){
        //   if (color == "Cor") { return "blue;"}
        //   if (color == "Cor") { return "blueviolet;"}
        //   if (color == "Cor") { return "crimson;"}
        //   if (color == "Cor") { return "darkgreen;"}
        //   if (color == "Cor") { return "deeppink;"}
        //   if (color == "Cor") { return "hotpink;"}
        //   if (color == "Cor") { return "red;"}
        //   if (color == "Cor") { return "yellow;"}
        //   if (color == "Cor") { return "orangered;"}
        //   if (color == "Cor") { return "springgreen;"}
        //   if (color == "Cor") { return "blue;"}
        //   if (color == "Cor") { return "blue;"}
        // }

        // function applyColor(cardId, color){
        //   console.log("color", color)
        //   console.log("cardId", cardId)
        //   var data = {
        //     cardId: cardId,
        //     color: color
        //   }
        //   socket.emit('setColor', data);
        // }

        function showLoading(game){
          $("#alertAddCards").show();
        }

        function updateGame(game){
          console.log("update Game", game);
          if (player == ""){
            return;
          }
          $("#logs").html('');
          // if (player != "Player1" && player != "Player2"){
          //   return;
          // }

          clear();

          renderCards(game.players);
          renderLogs(game.logs);
          // renderPannels(game.players);
        }

        function renderLogs(logs){
          for(var log of logs){
            renderLog(log);
          }
        }

        function renderCards(players){
          var selectedPlayer = players.filter(function(item) { return item.name == player })[0];
          var versusPlayer = players.filter(function(item) { return item.name != player })[0];

          for(var card of selectedPlayer.hand){renderCard(card, "containerBottom")};
          for(var card of selectedPlayer.lands){renderCard(card, "arenaPlayerLands")};
          for(var card of selectedPlayer.nonLands){renderCard(card, "arenaPlayerCards")};
          for(var card of selectedPlayer.xHand){renderCard(card, "containerTop")};
          for(var card of selectedPlayer.xLands){renderCard(card, "arenaOpponentLands")};
          for(var card of selectedPlayer.xNonLands){renderCard(card, "arenaOpponentCards")};

          for(var card of versusPlayer.hand){renderCard(card, "containerTop")};
          for(var card of versusPlayer.lands){renderCard(card, "arenaOpponentLands")};
          for(var card of versusPlayer.nonLands){renderCard(card, "arenaPlayerCards")};
          for(var card of versusPlayer.xHand){renderCard(card, "containerBottom")};
          for(var card of versusPlayer.xLands){renderCard(card, "arenaPlayerLands")};
          for(var card of versusPlayer.xNonLands){renderCard(card, "arenaPlayerCards")};
        }

        function clear(){
          $("#containerTop").html('');
          $("#arenaOpponentLands").html('');
          $("#arenaOpponentCards").html('');
          $("#arenaPlayerCards").html('');
          $("#arenaPlayerLands").html('');
          $("#containerBottom").html('');
        }

        function renderCard(card, container){

          var turned = card.turned ? " turned " : "";
          var color = card.color != " none " ? " " + card.color + " " : ""
          var id = card.id;
          var img = (card.reveal ||  card.owner == player)
            ? card.uri
            : defaultCard;
          
          $("#" + container).append(`
            <div class="mtgCardBox ` + turned + color + `">
              <img 
                id="` + id + `" 
                draggable="true" 
                ondragstart="drag(event)" 
                onClick="clickCard(event)"
                class="mtgCard" 
                src="` + img + `" 
                >
              </div>
          `);
        }

        function renderLog(log){
          $("#logs").append(`
            <div class="list-group-item list-group-item-action py-3 lh-tight">
              <div class="d-flex w-100 align-items-center justify-content-between">
                <div class="col-10 mb-1 small">` + log.text + `</div>
                <small class="text-muted">` + log.time + `</small>
              </div>
            </div>
          `);
        }
		
		    function getContainer(playerCard, container){
          if(playerCard == player){
            if(container == "player1Land") {return "#arenaPlayerLands"};
            if(container == "player2Land") {return "#arenaOpponentLands"};
            if(container == "player1NonLand") {return "#arenaPlayerCards"};
            if(container == "player2NonLand") {return "#arenaOpponentCards"};
            if(container == "player1Hand") {return "#containerBottom"};
            if(container == "player2Hand") {return "#containerTop"};
          }
          else {
            if(container == "player1Land") {return "#arenaOpponentLands"};
            if(container == "player2Land") {return "#arenaPlayerLands"};
            if(container == "player1NonLand") {return "#arenaOpponentCards"};
            if(container == "player2NonLand") {return "#arenaPlayerCards"};
            if(container == "player1Hand") {return "#containerTop"};
            if(container == "player2Hand") {return "#containerBottom"};
          }
        }

        // function getContainerReverse(container){
        //   if(player == "Player1"){
        //     if(container == "arenaPlayerLands") {return "player1Land"};
        //     if(container == "arenaOpponentLands") {return "player2Land"};
        //     if(container == "arenaPlayerCards") {return "player1NonLand"};
        //     if(container == "arenaOpponentCards") {return "player2NonLand"};
        //     if(container == "containerBottom") {return "player1Hand"};
        //     if(container == "containerTop") {return "player2Hand"};
        //   }
        //   if(player == "Player2"){
        //     if(container == "arenaOpponentLands") {return "player1Land"};
        //     if(container == "arenaPlayerLands") {return "player2Land"};
        //     if(container == "arenaOpponentCards") {return "player1NonLand"};
        //     if(container == "arenaPlayerCards") {return "player2NonLand"};
        //     if(container == "containerTop") {return "player1Hand"};
        //     if(container == "containerBottom") {return "player2Hand"};
        //   }
        // }

        function dragable(selected){
            dragElement(document.getElementById(selected));
        }
        
        function allowDrop(ev) {
          ev.preventDefault();
        }

        function drag(ev) {
          ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
          ev.preventDefault();
          var data = ev.dataTransfer.getData("text");
          if (data == "draw"){
            socket.emit('draw', player);
            return;
          }
          moveCard(data, ev.toElement.id);
          ev.target.appendChild(document.getElementById(data));
        }

        function moveCard(cardId, container, player){
          socket.emit('move', {
              cardId: cardId,
              container: container,
              player: player
          });
        }
        
        // function clickCard(ev){
        //   console.log("click");
          
        //   if (keySpacePressed){applyColor(ev.target.id, selectedColor); return;}
        //   if (key0Pressed){applyColor(ev.target.id, 'colorblue'); return;}
        //   if (key1Pressed){applyColor(ev.target.id, 'colorblueviolet'); return;}
        //   if (key2Pressed){applyColor(ev.target.id, 'colordeeppink'); return;}
        //   if (key3Pressed){applyColor(ev.target.id, 'colorhotpink'); return;}
        //   if (key4Pressed){applyColor(ev.target.id, 'colorred'); return;}
        //   if (key5Pressed){applyColor(ev.target.id, 'coloryellow'); return;}
        //   if (key6Pressed){applyColor(ev.target.id, 'colororangered'); return;}
        //   if (key7Pressed){applyColor(ev.target.id, 'colorspringgreen'); return;}
        //   if (key8Pressed){applyColor(ev.target.id, 'colormidnightblue'); return;}
        //   if (key9Pressed){applyColor(ev.target.id, 'colorolivedrab'); return;}

        //   // se control estiver pressionado
        //   if (ev.ctrlKey){
        //     console.log("turncard")
        //     turnCard(ev)
        //     return;
        //   } 

        //   //se alt estiver pressionado
        //   if (ev.altKey){
        //     revealCard(ev)
        //     return;
        //   } 

        //   viewCard(ev);
        // }

        // function revealCard(ev){
        //   socket.emit('reveal', ev.target.id);
        // }

        // function turnCard(ev){
        //   socket.emit('turn', ev.target.id);
        // }

        // function viewCard(ev){
        //   var cardUri = ev.srcElement.currentSrc;
        //   $("#amplifierCard").html('');
        //   $("#amplifierCard").append(`
        //     <img src="` + cardUri + `">
        //   `)
        // }
        
        function showModal(modal){
          $(modal).modal();
        }

        function closeModal(modal){
          $(modal).modal('hide');
        }

        function init(){
          showLoading();
          var uri = $("#deckUri").val();
          player = $("#playerName").val();
          var data = {
            uri: uri,
            player: player
          }
          socket.emit('init', data);
        }
    </script>
</body>
</html>


