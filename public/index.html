<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Simulator</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/socket.io-client@3.1.3/dist/socket.io.min.js"></script> -->
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- fullPannel -->
    <div id="fullPannel" class="col-xl-12">

        <!-- floatLeft -->
        <div id="floatLeft" class="col-xl-2">
            <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width: 100%;">

              <div class="btn-group btn-group-toggle" style="text-align: center;" data-toggle="buttons">
                <label class="btn btn-secondary active">
                  <input type="radio" name="options" id="option1" autocomplete="off" checked=""> <h3>-</h3>
                </label>
                <label class="btn btn-secondary">
                  <input type="radio" name="options" id="option2" autocomplete="off" disabled=""><h3 id="#lifeOpponent">0</h3>
                </label>
                <label class="btn btn-secondary active">
                  <input type="radio" name="options" id="option3" autocomplete="off"><h3>+</h3>
                </label>
              </div>
              
                <hr>
                <ul class="nav nav-pills flex-column mb-auto">
                  <li class="nav-item">
                    <a href="#" class="nav-link text-white">
                      Adicionar Marcador
                    </a>
                  </li>
                  <li>
                    <a href="#" class="nav-link text-white">
                      Adicionar Token
                    </a>
                  </li>
                  <li>
                    <a href="#" class="nav-link text-white">
                      Orders
                    </a>
                  </li>
                  <li>
                    <a href="#" class="nav-link text-white">
                      Products
                    </a>
                  </li>
                  <li>
                    <a href="#" class="nav-link text-white">
                      Customers
                    </a>
                  </li>
                </ul>
                <div id="playerName"></div>
                <div style="
                  display: flex;
                  flex-direction: column;
                  align-content: center;
                  justify-content: space-evenly;
                  align-items: stretch;
                  flex-wrap: wrap;">

                  <div style="display: flex;">
                    <div class="pile">
                      <div class="titlePile">Exílio</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>
                    <div class="pile">
                      <div class="titlePile">Cemitério</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>
                    <div class="pile">
                      <div class="titlePile">Comando</div>
                      <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="60pt">
                    </div>
                  </div>
                  <div style="display: flex;">
                    <div class="pile">
                      <div class="titlePile">Grimório</div>
                      <img id="draw" draggable="true" ondragstart="drag(event)" src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" width="180pt">
                    </div>
                  </div>
                </div>
                
                
                <hr>
                
                <div class="btn-group btn-group-toggle" style="text-align: center;" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="options" id="option1" autocomplete="off" checked=""> <h3>-</h3>
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="options" id="option2" autocomplete="off" disabled=""><h3 id="lifePlayer">0</h3>
                  </label>
                  <label class="btn btn-secondary active">
                    <input type="radio" name="options" id="option3" autocomplete="off"><h3>+</h3>
                  </label>
                </div>
                <div class="dropdown">
                  
                  <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="#">New project...</a></li>
                    <li><a class="dropdown-item" href="#">Settings</a></li>
                    <li><a class="dropdown-item" href="#">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">Sign out</a></li>
                  </ul>
                </div>
              </div>
        </div>

        <!-- containerCenter -->
        <div id="containerCenter" class="col-xl-8"">
            <div id="containerTop" class="playerCards " ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            <div id="fullArena" >

              <div id="arenaOpponentLands" class="containerArena containerLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="arenaOpponentCards" class="containerArena containerNonLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="divisor"><div class="boardCard"></div></div>
              <div id="arenaPlayerCards" class="containerArena containerNonLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div id="arenaPlayerLands" class="containerArena containerLand" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              
            </div>
            <div id="containerBottom" class="playerCards" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
        </div>

        <!-- floatRight -->
        <div id="floatRight" class="col-xl-2">
            <div id="amplifierCard">
              <img src="https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg" alt="" srcset="">
            </div>

            <div id="pannel" class="mb-3">
              <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 100%;">
                <div id="colors" class="list-group list-group-flush border-bottom scrollarea">
                  <div onclick="setColor('colorblue')" class="colorButton colorblue"></div>
                  <div onclick="setColor('colorblueviolet')" class="colorButton colorblueviolet"></div>
                  <div onclick="setColor('colorcrimson')" class="colorButton colorcrimson"></div>
                  <div onclick="setColor('colordarkgreen')" class="colorButton colordarkgreen"></div>
                  <div onclick="setColor('colordeeppink')" class="colorButton colordeeppink"></div>
                  <div onclick="setColor('colorhotpink')" class="colorButton colorhotpink"></div>
                  <div onclick="setColor('colorred')" class="colorButton colorred"></div>
                  <div onclick="setColor('coloryellow')" class="colorButton coloryellow"></div>
                  <div onclick="setColor('colororangered')" class="colorButton colororangered"></div>
                  <div onclick="setColor('colorspringgreen')" class="colorButton colorspringgreen"></div>
                  <div onclick="setColor('colormidnightblue')" class="colorButton colormidnightblue"></div>
                  <div onclick="setColor('colorolivedrab')" class="colorButton colorolivedrab"></div>
                </div>
              </div>
            </div>

            <div id="logPannel">
              <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 100%;">
                <a href="/" class="d-flex align-items-center flex-shrink-0 p-3 link-dark text-decoration-none border-bottom">
                  <svg class="bi me-2" width="30" height="24"><use xlink:href="#bootstrap"></use></svg>
                  <span class="fs-5 fw-semibold">Histórico da partida</span>
                </a>
                <div id="logs" class="list-group list-group-flush border-bottom scrollarea">
                </div>
              </div>
            </div>
        </div>

    </div>

    <script type="text/javascript">

        var server = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
          ? "localhost"
          : "192.168.0.110";

        var socket = io('http://' + server + ':3000');
        
        var spacePressed = false;
        $(window).keydown(function(ev) {
          if (ev.which == 32) { // space
            spacePressed = true;
            console.log(spacePressed)
          }
        }).keyup(function(ev) {
          if (ev.which == 32) { // space
            spacePressed = false;
            console.log(spacePressed)
          }
        });

        const EContainers = Object.freeze({
          "player1Land" : 1,
          "player2Land" : 2,
          "player1NonLand" : 3,
          "player2NonLand" : 4,
          "player1Grave" : 5,
          "player2Grave" : 6,
          "player1Exilium" : 7,
          "player2Exilium" : 8,
          "player1Deck" : 9,
          "player2Deck" : 10,
          "player1Command": 11,
          "player2Command": 12,
          "player1Hand": 13,
          "player2Hand": 14,
        })


        var AllCards = {};
        var SelectedObject = {};
        var player = "";
        var defaultCard = "https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg";
        var selectedColor = "none";

        socket.on('updateGame', function(game){
          updateGame(game);
        })

        socket.on('setPlayer', function(playerName){
          addPlayer(playerName);
        })

        function addPlayer(playerName){
          player = playerName;
          $("#playerName").html('');
          $("#playerName").append(player);
          socket.emit('addPlayer', player);
        }

        function setColor(color){
          selectedColor = color;
          console.log(color)
        }

        function applyColor(cardId){
          console.log("color", selectedColor)
          console.log("cardId", cardId)
          var data = {
            cardId: cardId,
            color: selectedColor
          }
          socket.emit('setColor', data);
        }

        function updateGame(game){

          $("#logs").html('');
          if (player != "Player1" && player != "Player2"){
            return;
          }

          clear();

          for(var card of game.cards){
            renderCard(card);
          }

          for(var log of game.logs){
            renderLog(log);
          }
        }

        function clear(){
          $("#containerTop").html('');
          $("#arenaOpponentLands").html('');
          $("#arenaOpponentCards").html('');
          $("#arenaPlayerCards").html('');
          $("#arenaPlayerLands").html('');
          $("#containerBottom").html('');
        }

        function renderCard(card){

          // Força exibição de cards que estão em jogo (necessário melhoria para utilizar "Profetizar")
          if (card.container != "player1Hand" && card.container != "player2Hand"){
            card.reveal = true;
          }

          // não denderiza cartas dos decks
          if (card.container == "player1Deck" || card.container == "player2Deck"){
            return;
          }

          var container = getContainer(card);
          
          var turned = card.turned ? " turned " : "";
          var color = card.color != " none " ? " " + card.color + " " : ""
          var id = card.id;
          var img = (card.reveal ||  card.owner == player)
            ? card.uri
            : defaultCard;
          
          console.log("Container ► ", container)

          $(container).append(`
            <div class="mtgCardBox ` + turned + color + `">
              <img 
                id="` + id + `" 
                draggable="true" 
                ondragstart="drag(event)" 
                onClick="clickCard(event)"
                class="mtgCard" 
                src="` + img + `" 
                >
              </div>
          `);
        }

        function renderLog(log){
          $("#logs").append(`
            <div class="list-group-item list-group-item-action py-3 lh-tight">
              <div class="d-flex w-100 align-items-center justify-content-between">
                <div class="col-10 mb-1 small">` + log.text + `</div>
                <small class="text-muted">` + log.time + `</small>
              </div>
            </div>
          `);
        }
		
		    function getContainer(card){
          if(player == "Player1"){
            if(card.container == "player1Land") {return "#arenaPlayerLands"};
            if(card.container == "player2Land") {return "#arenaOpponentLands"};
            if(card.container == "player1NonLand") {return "#arenaPlayerCards"};
            if(card.container == "player2NonLand") {return "#arenaOpponentCards"};
            if(card.container == "player1Hand") {return "#containerBottom"};
            if(card.container == "player2Hand") {return "#containerTop"};
          }
          if(player == "Player2"){
            if(card.container == "player1Land") {return "#arenaOpponentLands"};
            if(card.container == "player2Land") {return "#arenaPlayerLands"};
            if(card.container == "player1NonLand") {return "#arenaOpponentCards"};
            if(card.container == "player2NonLand") {return "#arenaPlayerCards"};
            if(card.container == "player1Hand") {return "#containerTop"};
            if(card.container == "player2Hand") {return "#containerBottom"};
          }
        }

        function getContainerReverse(container){
          if(player == "Player1"){
            if(container == "arenaPlayerLands") {return "player1Land"};
            if(container == "arenaOpponentLands") {return "player2Land"};
            if(container == "arenaPlayerCards") {return "player1NonLand"};
            if(container == "arenaOpponentCards") {return "player2NonLand"};
            if(container == "containerBottom") {return "player1Hand"};
            if(container == "containerTop") {return "player2Hand"};
          }
          if(player == "Player2"){
            if(container == "arenaOpponentLands") {return "player1Land"};
            if(container == "arenaPlayerLands") {return "player2Land"};
            if(container == "arenaOpponentCards") {return "player1NonLand"};
            if(container == "arenaPlayerCards") {return "player2NonLand"};
            if(container == "containerTop") {return "player1Hand"};
            if(container == "containerBottom") {return "player2Hand"};
          }
        }

        function dragable(selected){
            dragElement(document.getElementById(selected));
        }
        
        function allowDrop(ev) {
          ev.preventDefault();
        }

        function drag(ev) {
          ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
          ev.preventDefault();
          var data = ev.dataTransfer.getData("text");
          if (data == "draw"){
            socket.emit('draw', player);
            return;
          }
          moveCard(data, ev.toElement.id);
          ev.target.appendChild(document.getElementById(data));
        }

        function moveCard(cardId, container){
          socket.emit('move', {
              cardId: cardId,
              container: getContainerReverse(container)
          });
        }
        
        function clickCard(ev){
          console.log("click");
          
          if (spacePressed){
            console.log("entrou")
            applyColor(ev.target.id)
            return;
          }

          // se control estiver pressionado
          if (ev.ctrlKey){
            turnCard(ev)
            return;
          } 

          //se alt estiver pressionado
          if (ev.altKey){
            revealCard(ev)
            return;
          } 

          viewCard(ev);
        }

        function revealCard(ev){
          socket.emit('reveal', ev.target.id);
        }

        function turnCard(ev){
          socket.emit('turn', ev.target.id);
        }

        function viewCard(ev){
          var cardUri = ev.srcElement.currentSrc;
          $("#amplifierCard").html('');
          $("#amplifierCard").append(`
            <img src="` + cardUri + `">
          `)
        }
        

    </script>
</body>
</html>


